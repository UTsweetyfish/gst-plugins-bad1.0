From 11353b3f6e2f047cc37483d21e6a37ae558896bc Mon Sep 17 00:00:00 2001
Author: Andrew Wesie <andrew@theori.io>
Date: 2020-10-16
Subject: [PATCH] codecparsers: h264parser: guard against ref_pic_markings overflow
--- a/ext/openexr/Makefile.am
+++ b/ext/openexr/Makefile.am
@@ -6,7 +6,7 @@ libgstopenexr_la_CFLAGS = \
 	$(OPENEXR_CFLAGS)
 libgstopenexr_la_CXXFLAGS = \
 	$(GST_PLUGINS_BASE_CFLAGS) $(GST_BASE_CFLAGS) $(GST_CXXFLAGS) \
-	$(OPENEXR_CFLAGS) -std=c++98
+	$(OPENEXR_CFLAGS) -std=c++11
 libgstopenexr_la_LIBADD = \
 	$(GST_PLUGINS_BASE_LIBS) -lgstvideo-$(GST_API_VERSION) \
 	$(GST_BASE_LIBS) $(GST_LIBS) $(OPENEXR_LIBS)
--- a/gst-libs/gst/codecparsers/gsth264parser.c
+++ b/gst-libs/gst/codecparsers/gsth264parser.c
@@ -712,13 +712,17 @@ gst_h264_slice_parse_dec_ref_pic_marking
 
       dec_ref_pic_m->n_ref_pic_marking = 0;
       while (1) {
-        refpicmarking =
-            &dec_ref_pic_m->ref_pic_marking[dec_ref_pic_m->n_ref_pic_marking];
-
         READ_UE (nr, mem_mgmt_ctrl_op);
         if (mem_mgmt_ctrl_op == 0)
           break;
 
+        if (dec_ref_pic_m->n_ref_pic_marking >=
+            G_N_ELEMENTS (dec_ref_pic_m->ref_pic_marking))
+          goto error;
+
+        refpicmarking =
+            &dec_ref_pic_m->ref_pic_marking[dec_ref_pic_m->n_ref_pic_marking];
+
         refpicmarking->memory_management_control_operation = mem_mgmt_ctrl_op;
 
         if (mem_mgmt_ctrl_op == 1 || mem_mgmt_ctrl_op == 3)
